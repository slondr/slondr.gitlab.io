var ZVM=function(){function N(a,b){return a[b]<<24|a[b+1]<<16|a[b+2]<<8|a[b+3]}function G(a){return[255&a>>24,255&a>>16,255&a>>8,255&a]}function B(a,b){return String.fromCharCode(a[b],a[b+1],a[b+2],a[b+3])}function C(a){return[a.charCodeAt(0),a.charCodeAt(1),a.charCodeAt(2),a.charCodeAt(3)]}function U(a,b){return Function.prototype.bind?a.bind(b):function(){a.apply(b,[].slice.call(arguments))}}function x(a,b){for(var c in b)a[c]=b[c];return a}function y(a){return a<<16>>16}function D(a){for(var b=
0,c=a.length,d=[];c>b;)d[b/2]=a[b++]<<8|a[b++];return d}function O(a){return a.replace(/(e\.)?U2S\(([^(]+?)\)/g,"(($2)<<16>>16)").replace(/(e\.)?S2U\(([^(]+?)\)/g,"(($2)&65535)").replace(/([\w.]+)\.getUint8\(([^(]+?)\)/g,"$1[$2]").replace(/([\w.]+)\.getUint16\(([^(]+?)\)/g,"($1[$2]<<8|$1[$2+1])")}function V(a,b){var c,d,e=[];for(c in a)0<=b.indexOf(c)&&(d=/function\s*\(([^(]*)\)\s*\{([\s\S]+)\}/.exec(""+a[c]),e.push(c+":function("+d[1]+"){"+O(d[2])+"}"));x(a,eval("({"+e.join()+"})"))}function f(a,
b,c){return c=c||{},b&&(c.func=b),a.subClass(c)}function W(a,b){for(var c,d,e=0;a.ops.length-1>e;){if(a.ops[e].offset===b){if(2===a.ops.length-e&&a.ops[e+1].offset)return c=a.ops.pop(),d=a.ops.pop(),d.cond.invert=!d.cond.invert,c.cond=new P([d.cond,c.cond],"&&"),c.labels=d.labels.concat(c.labels),a.ops.push(c),1;b=new H(a.e,a.ops[e+1].pc);b.ops=a.ops.slice(e+1);c=b.ops.length-1;a.ops.length=e+1;a=a.ops[e];a.result=b;a.cond.invert=!a.cond.invert;c=b.ops[c];140===c.code&&y(c.operands[0].v)+c.next-2===
a.pc?(a.keyword="while",b.ops.pop()):b.stopper=c.stopper;return 1}e++}}function Q(a){return""+a}var r=function(){var a,b=0,c=/\b_super\b/,d=function(){};for(a in{toString:1})var e=1;return d.subClass=function(a){var g,l,f=this.prototype,E=!/native code/.test(""+a.toString)&&a.toString,h=function(a,b){return function(){var c,d=this._super;return this._super=f[a],c=b.apply(this,arguments),this._super=d,c}};b=1;var k=new this;b=0;for(g in a)k[g]="function"==typeof a[g]&&"function"==typeof f[g]&&c.test(a[g])?
h(g,a[g]):a[g];return!e&&E&&(k.toString=c.test(E)?h("toString",E):E),l=k.init?function(){b||this.init.apply(this,arguments)}:function(){},l.prototype=k,l.constructor=l,l.subClass=d.subClass,l},d}(),v=r.subClass({init:function(a){if(this.type="",this.chunks=[],a){if("FORM"!==B(a,0))throw Error("Not an IFF file");this.type=B(a,8);for(var b=12,c=a.length;c>b;){var d=N(a,b+4);if(0>d||d+b>c)throw Error("IFF: Chunk out of range");this.chunks.push({type:B(a,b),offset:b,data:a.slice(b+8,b+8+d)});b+=8+d;d%
2&&b++}}},write:function(){for(var a=C(this.type),b=0,c=this.chunks.length;c>b;b++){var d=this.chunks[b],e=d.data,l=e.length;a=a.concat(C(d.type),G(l),e);l%2&&a.push(0)}return C("FORM").concat(G(a.length),a)}});v.num_from=N;v.num_to_word=G;v.text_from=B;v.text_to_word=C;[].indexOf||(Array.prototype.indexOf=function(a,b){b=b||0;for(var c=this.length;c>b;b++)if(this[b]===a)return b;return-1});var I=void 0!==I?I:{log:function(){},info:function(){},warn:function(){}},X=function(a){return a=a.slice(),
ZVM?x(a,{data:a,getUint8:function(b){return a[b]},getUint16:function(b){return a[b]<<8|a[b+1]},getBuffer:function(b,c){return a.slice(b,b+c)},getBuffer16:function(b,c){return D(a.slice(b,b+2*c))},setUint8:function(b,c){return a[b]=255&c},setUint16:function(b,c){return a[b]=255&c>>8,a[b+1]=255&c,65535&c},setBuffer:function(b,c){for(var d=0,e=c.length;e>d;)a[d+b]=c[d++]}}):void 0},J=r.subClass({init:function(a,b){this.e=a;this.v=b},toString:function(){return this.v},U2S:function(){return y(this.v)}}),
w=J.subClass({toString:function(){var a=this.v;return this.indirect?"e.indirect("+a+")":0===a?"s.pop()":15>--a?"l["+a+"]":"m.getUint16("+(this.e.globals+2*(a-15))+")"},store:function(a){var b=this.v;return this.indirect?"e.indirect("+b+","+a+")":this.returnval?"e.variable("+b+","+a+")":0===b?"s.push("+a+")":15>--b?"l["+b+"]="+a:"m.setUint16("+(this.e.globals+2*(b-15))+","+a+")"},U2S:function(){return"e.U2S("+this+")"}}),h=r.subClass({init:function(a,b,c,d,e,l){this.e=a;this.context=b;this.code=c;
this.pc=d;this.labels=[this.pc+"/"+this.code];this.next=e;this.operands=l;this.post&&this.post()},toString:function(){return this.label()+(this.func?this.func.apply(this,this.operands):"")},args:function(a){return this.operands.join(a)},label:function(){return"/* "+this.labels.join()+" */ "}}),t=h.subClass({stopper:1}),z=t.subClass({storer:1,post:function(){this.storer=this.operands.pop();this.origfunc=this.func;this.func=this.newfunc},newfunc:function(){return"e.pc="+this.next+";"+this.origfunc.apply(this,
arguments)}}),P=r.subClass({init:function(a,b){this.ops=a||[];this.code=b||"||"},toString:function(){for(var a,b=0,c=[];this.ops.length>b;)a=this.ops[b++],c.push(a.func?(a.iftrue?"":"!(")+a.func.apply(a,a.operands)+(a.iftrue?"":")"):a);return(this.invert?"(!(":"(")+c.join(this.code)+(this.invert?"))":")")}}),n=h.subClass({brancher:1,keyword:"if",post:function(){var a,b,c=this.operands.pop(),d=c[1];this.iftrue=c[0];0===d||1===d?a="e.ret("+d+")":(d+=this.next-2,this.context.targets.push(d),a="e.pc="+
d);this.result=a+";return";this.offset=d;this.cond=new P([this]);this.context.ops.length&&(b=this.context.ops.pop(),b.offset===d?(this.cond.ops.unshift(b.cond),this.labels=b.labels,this.labels.push(this.pc+"/"+this.code)):this.context.ops.push(b))},toString:function(){var a=this.result;return a instanceof H&&(a+=a.stopper?"; return":"",1<this.result.ops.length&&(a="\n"+a+"\n")),this.label()+this.keyword+this.cond+" {"+a+"}"}}),K=n.subClass({storer:1,post:function(){this._super();this.storer=this.operands.pop();
this.storer.returnval=1;this.origfunc=this.func;this.func=this.newfunc},newfunc:function(){return this.storer.store(this.origfunc.apply(this,arguments))}}),k=h.subClass({storer:1,post:function(){this.storer=this.operands.pop()},toString:function(){var a=this._super();return this.storer?this.storer.store(a):a}}),A=t.subClass({result:{v:-1},toString:function(){return this.label()+"e.call("+this.operands.shift()+","+this.result.v+","+this.next+",["+this.args()+"])"}}),F=A.subClass({storer:1,post:function(){this.result=
this.operands.pop()}}),H=r.subClass({init:function(a,b){this.e=a;this.pc=b;this.pre=[];this.ops=[];this.post=[];this.targets=[]},toString:function(){return this.pre.join("")+this.ops.join(";")+this.post.join("")}}),Y=H.subClass({toString:function(){return this.pre.unshift("var l=e.l,m=e.m,s=e.s;\n"),this._super()}}),R=v.subClass({init:function(a){if(this._super(a),a){if("IFZS"!==this.type)throw Error("Not a Quetzal savefile");a=0;for(var b=this.chunks.length;b>a;a++){var c=this.chunks[a].type,d=this.chunks[a].data;
"CMem"===c||"UMem"===c?(this.memory=d,this.compressed="CMem"===c):"Stks"===c?this.stacks=d:"IFhd"===c&&(this.release=d.slice(0,2),this.serial=d.slice(2,8),this.checksum=d.slice(8,10),this.pc=d[10]<<16|d[11]<<8|d[12])}}},write:function(){this.type="IFZS";var a=this.pc;return this.chunks=[{type:"IFhd",data:this.release.concat(this.serial,this.checksum,255&a>>16,255&a>>8,255&a)},{type:this.compressed?"CMem":"UMem",data:this.memory},{type:"Stks",data:this.stacks}],this._super()}}),S=r.subClass({init:function(a,
b){this.e=a;this.buffer="";x(this,this.formatters[a.env.formatter]||{});this.mono=b;this.process_colours();this.currentwin=0;this.status=[];a.orders.push({code:"stream",name:"status"},{code:"stream",name:"main"},{code:"find",name:"main"})},clear_window:function(){this.e.orders.push({code:"clear",name:"main",bg:this.bg})},erase_line:function(a){1===a&&(this.flush(),this.status.push({code:"eraseline"}))},erase_window:function(a){this.flush();1>a&&this.clear_window();-1===a&&this.split_window(0);-2!==
a&&1!==a||this.status.push({code:"clear"})},flush:function(){if(""!==this.buffer){var a={code:"stream",text:this.buffer,props:this.format()};(this.currentwin?this.status:this.e.orders).push(a);this.buffer=""}},format:function(){var a,b={},c=[],d=this.fg,e=this.bg;return this.bold&&c.push("zvm-bold"),this.italic&&c.push("zvm-italic"),this.mono&&c.push("zvm-mono"),this.reverse&&(a=d,d=e||this.env.bg,e=a||this.env.fg),void 0!==d&&(isNaN(d)?b.css={color:d}:c.push("zvm-fg-"+d)),void 0!==e&&(isNaN(e)?(b.css||
(b.css={}),b.css["background-color"]=e):c.push("zvm-bg-"+e)),c.length&&(b["class"]=c.join(" ")),b},get_cursor:function(a){this.status.push({code:"get_cursor",addr:a});this.e.act()},process_colours:function(){function a(a){var b,c=Math.round,d=/(\d+),\s*(\d+),\s*(\d+)|#(\w{1,2})(\w{1,2})(\w{1,2})/.exec(a);return d[1]?b=[d[1],d[2],d[3]]:(b=[parseInt(d[4],16),parseInt(d[5],16),parseInt(d[6],16)],4===a.length&&(b=[b[0]<<4|b[0],b[1]<<4|b[1],b[2]<<4|b[2]])),c(b[2]/8.226)<<10|c(b[1]/8.226)<<5|c(b[0]/8.226)}
var b=[65534,65535,0,29,832,957,22944,31775,30624,32767,23254,17969,11627],c=this.e.env.fgcolour,d=this.e.env.bgcolour,e=c?a(c):65535,l=d?a(d):65535,g=b.indexOf(e);b=b.indexOf(l);2>g&&(g=c||2);2>b&&(b=d||9);this.env={fg:g,bg:b,fg_true:e,bg_true:l}},set_colour:function(a,b){this.flush();1===a&&(this.fg=void 0);1<a&&13>a&&(this.fg=a);1===b&&(this.bg=void 0);1<b&&13>b&&(this.bg=b)},set_cursor:function(a,b){this.flush();this.status.push({code:"cursor",to:[a-1,b-1]})},set_font:function(a){if(1!==a&&4!==
a)return 0;var b=4&this.mono?4:1;return a!==b&&(this.flush(),this.mono^=4),b},set_style:function(a){this.flush();0===a&&(this.reverse=this.bold=this.italic=0,this.mono&=254);1&a&&(this.reverse=1);2&a&&(this.bold=1);4&a&&(this.italic=1);8&a&&(this.mono|=1)},set_true_colour:function(a,b){function c(a){a=Math.round(8.226*(31&a))<<16|Math.round(8.226*((992&a)>>5))<<8|Math.round(8.226*((31744&a)>>10));for(a=a.toString(16);6>a.length;)a="0"+a;return"#"+a}this.flush();65535===a?this.fg=void 0:32768>a&&(this.fg=
c(a));65535===b?this.bg=void 0:32768>b&&(this.bg=c(b))},set_window:function(a){this.flush();this.currentwin=a;this.e.orders.push({code:"find",name:a?"status":"main"});a&&this.status.push({code:"cursor",to:[0,0]})},split_window:function(a){this.flush();this.status.push({code:"height",lines:a})},update_header:function(){var a=this.e.m;a.setUint8(44,isNaN(this.env.bg)?1:this.env.bg);a.setUint8(45,isNaN(this.env.fg)?1:this.env.fg);this.e.extension_table(5,this.env.fg_true);this.e.extension_table(6,this.env.bg_true)},
formatters:{}});v=f(n,function(){return 1});var L=k.subClass({storer:0,post:function(){var a=this.operands,b=a[0],c=b instanceof w;a[0]=new w(this.e,c?b:b.v);(c||0===b.v)&&(a[0].indirect=1);this.storer=142===this.code?a.pop():a.shift();0===a.length&&a.push(new w(this.e,0))},func:Q}),T=h.subClass({func:function(a){var b=a.v-1,c=this.code%2?1:-1;return a instanceof w||14<b?"e.incdec("+a+","+c+")":(0>b?"e.s[e.s.length-1]=e.S2U(e.s[e.s.length-1]+":"e.l["+b+"]=e.S2U(e.l["+b+"]+")+c+")"}}),M={1:f(n,function(){return 2===
arguments.length?this.args("==="):"e.jeq("+this.args()+")"}),2:f(n,function(a,b){return a.U2S()+"<"+b.U2S()}),3:f(n,function(a,b){return a.U2S()+">"+b.U2S()}),4:f(n,function(a,b){return"e.U2S(e.incdec("+a+",-1))<"+b.U2S()}),5:f(n,function(a,b){return"e.U2S(e.incdec("+a+",1))>"+b.U2S()}),6:f(n,function(){return"e.jin("+this.args()+")"}),7:f(n,function(){return"e.test("+this.args()+")"}),8:f(k,function(){return this.args("|")}),9:f(k,function(){return this.args("&")}),10:f(n,function(){return"e.test_attr("+
this.args()+")"}),11:f(h,function(){return"e.set_attr("+this.args()+")"}),12:f(h,function(){return"e.clear_attr("+this.args()+")"}),13:L,14:f(h,function(){return"e.insert_obj("+this.args()+")"}),15:f(k,function(a,b){return"m.getUint16(e.S2U("+a+"+2*"+b.U2S()+"))"}),16:f(k,function(a,b){return"m.getUint8(e.S2U("+a+"+"+b.U2S()+"))"}),17:f(k,function(){return"e.get_prop("+this.args()+")"}),18:f(k,function(){return"e.find_prop("+this.args()+")"}),19:f(k,function(){return"e.find_prop("+this.args(",0,")+
")"}),20:f(k,function(){return"e.S2U("+this.args("+")+")"}),21:f(k,function(){return"e.S2U("+this.args("-")+")"}),22:f(k,function(){return"e.S2U("+this.args("*")+")"}),23:f(k,function(a,b){return"e.S2U(parseInt("+a.U2S()+"/"+b.U2S()+"))"}),24:f(k,function(a,b){return"e.S2U("+a.U2S()+"%"+b.U2S()+")"}),25:F,26:A,27:f(h,function(){return"e.ui.set_colour("+this.args()+")"}),28:f(t,function(a,b){return"while(e.call_stack.length>"+b+"){e.call_stack.shift()}return "+a}),128:f(n,function(a){return a+"===0"}),
129:f(K,function(a){return"e.get_sibling("+a+")"}),130:f(K,function(a){return"e.get_child("+a+")"}),131:f(k,function(a){return"e.get_parent("+a+")"}),132:f(k,function(a){return"e.get_prop_len("+a+")"}),133:T,134:T,135:f(h,function(a){return"e.print(2,"+a+")"}),136:F,137:f(h,function(a){return"e.remove_obj("+a+")"}),138:f(h,function(a){return"e.print(3,"+a+")"}),139:f(t,function(a){return"return "+a}),140:f(t,function(a){return"e.pc="+a.U2S()+"+"+(this.next-2)}),141:f(h,function(a){return"e.print(2,"+
a+"*"+this.e.addr_multipler+")"}),142:L.subClass({storer:1}),143:A,176:f(t,function(){return"return 1"}),177:f(t,function(){return"return 0"}),178:f(h,function(a){return"e.print(2,"+a+")"},{printer:1}),179:f(t,function(a){return"e.print(2,"+a+");e.print(1,13);return 1"},{printer:1}),180:h,183:f(t,function(){return"e.act(183)"}),184:f(t,function(a){return"return "+a},{post:function(){this.operands.push(new w(this.e,0))}}),185:f(k,function(){return"e.call_stack.length"}),186:f(t,function(){return"e.act(186)"}),
187:f(h,function(){return"e.print(1,13)"}),189:v,191:v,224:F,225:f(h,function(a,b,c){return"m.setUint16(e.S2U("+a+"+2*"+b.U2S()+"),"+c+")"}),226:f(h,function(a,b,c){return"m.setUint8(e.S2U("+a+"+"+b.U2S()+"),"+c+")"}),227:f(h,function(){return"e.put_prop("+this.args()+")"}),228:f(z,function(){return"e.read("+this.args()+","+this.storer.v+")"}),229:f(h,function(a){return"e.print(4,"+a+")"}),230:f(h,function(a){return"e.print(0,"+a.U2S()+")"}),231:f(k,function(a){return"e.random("+a.U2S()+")"}),232:f(k,
Q,{post:function(){this.storer=new w(this.e,0)},storer:0}),233:L,234:f(h,function(a){return"e.ui.split_window("+a+")"}),235:f(h,function(a){return"e.ui.set_window("+a+")"}),236:F,237:f(h,function(a){return"e.ui.erase_window("+a.U2S()+")"}),238:f(h,function(a){return"e.ui.erase_line("+a+")"}),239:f(h,function(){return"e.ui.set_cursor("+this.args()+")"}),240:f(z,function(a){return"e.ui.get_cursor("+a+")"}),241:f(h,function(a){return"e.ui.set_style("+a+")"}),242:h,243:f(h,function(){return"e.output_stream("+
this.args()+")"}),244:h,245:h,246:f(z,function(){return"e.read_char("+(this.args()||"1")+","+this.storer.v+")"}),247:f(K,function(){return"e.scan_table("+this.args()+")"}),248:f(k,function(a){return"e.S2U(~"+a+")"}),249:A,250:A,251:f(h,function(){return"e.tokenise("+this.args()+")"}),252:f(h,function(){return"e.encode_text("+this.args()+")"}),253:f(h,function(){return"e.copy_table("+this.args()+")"}),254:f(h,function(){return"e.print_table("+this.args()+")"}),255:f(n,function(a){return a+"<=e.call_stack[0][4]"}),
1E3:f(z,function(){return"e.save("+(this.next-1)+","+this.storer.v+")"}),1001:f(z,function(){return"e.act(1001,"+this.storer.v+")"}),1002:f(k,function(a,b){return"e.S2U(e.log_shift("+a+","+b.U2S()+"))"}),1003:f(k,function(a,b){return"e.S2U(e.art_shift("+a.U2S()+","+b.U2S()+"))"}),1004:f(k,function(a){return"e.ui.set_font("+a+")"}),1009:f(k,function(){return"e.save_undo("+this.next+","+this.storer.v+")"}),1010:f(h,function(){return"if(e.restore_undo())return"},{storer:1}),1011:f(h,function(a){return"e.print(1,"+
a+")"}),1012:f(k,function(){return 3}),1013:f(h,function(){return"e.ui.set_true_colour("+this.args()+")"}),1014:h.subClass({brancher:1}),1030:f(k,function(){return"e.gestalt("+this.args()+")"})};r=r.subClass({art_shift:function(a,b){return 0<b?a<<b:a>>-b},call:function(a,b,c,d){if(0===a)return 0<=b&&this.variable(b,0),this.pc=c;var e=this.l.length,l=d.length;this.pc=a*this.addr_multipler;var g=this.m.getUint8(this.pc++);d=d.slice(0,g);for(a=d.length;g>a;a++)d.push(0);this.l=d.concat(this.l);this.call_stack.unshift([c,
b,g,this.s.length,l,e])},clear_attr:function(a,b){a=0|this.objects+14*a+b/8;this.m.setUint8(a,this.m.getUint8(a)&~(128>>b%8))},copy_table:function(a,b,c){c=y(c);var d=this.m,e=0,l=0>c;if(c=Math.abs(c),0!==b)if(l)for(;c>e;)d.setUint8(b+e,d.getUint8(a+e++));else d.setBuffer(b,d.getBuffer(a,c));else for(;c>e;)d.setUint8(a+e++,0)},encode_text:function(a,b,c,d){this.m.setBuffer(d,this.encode(this.m.getBuffer(a+c,b)))},extension_table:function(a,b){var c=this.extension;return!c||a>this.extension_count?
0:(c+=2*a,void 0===b?this.m.getUint16(c):(this.e.setUint16(c,b),void 0))},find_prop:function(a,b,c){var d,e=this.m,l=0,g=e.getUint16(this.objects+14*a+12);for(g+=2*e.getUint8(g)+1;;){if(d=e.getUint8(g),a=63&d,l===c)return a;if(a===b)return g+(128&d?2:1);if(b>a)return 0;l=a;128&d?(a=63&e.getUint8(g+1),g+=a?a+2:66):g+=64&d?3:2}},gestalt:function(a){switch(a){case 1:return 258;case 8192:return 1;case 8193:case 8194:return 2}return 0},get_child:function(a){return this.m.getUint16(this.objects+14*a+10)},
get_sibling:function(a){return this.m.getUint16(this.objects+14*a+8)},get_parent:function(a){return this.m.getUint16(this.objects+14*a+6)},get_prop:function(a,b){var c=this.m;return(a=this.find_prop(a,b))?(64&c.getUint8(a-1)?c.getUint16:c.getUint8)(a):c.getUint16(this.properties+2*(b-1))},get_prop_len:function(a){if(0===a)return 0;a=this.m.getUint8(a-1);return 128&a?(a&=63,0===a?64:a):64&a?2:1},incdec:function(a,b){var c,d;return 0===a?(c=65535&this.s.pop()+b,this.s.push(c),c):15>--a?this.l[a]=65535&
this.l[a]+b:(d=this.globals+2*(a-15),this.m.setUint16(d,this.m.getUint16(d)+b))},indirect:function(a,b){return 0===a?1<arguments.length?this.s[this.s.length-1]=b:this.s[this.s.length-1]:this.variable(a,b)},insert_obj:function(a,b){this.remove_obj(a);this.set_family(a,b,b,a,a,this.get_child(b))},jeq:function(){for(var a=1;arguments.length>a;)if(arguments[a++]===arguments[0])return 1},jin:function(a,b){return this.get_parent(a)===b},log_shift:function(a,b){return 0<b?a<<b:a>>>-b},output_stream:function(a,
b){if(a=y(a),1===a&&(this.streams[0]=1),-1===a&&(this.streams[0]=0),3===a&&this.streams[2].unshift([b,""]),-3===a)a=this.streams[2].shift(),b=this.text_to_zscii(a[1]),this.m.setUint16(a[0],b.length),this.m.setBuffer(a[0]+2,b)},_print:function(a){this.streams[2].length?this.streams[2][0][1]+=a:this.streams[0]&&((2&this.m.getUint8(17))!==(2&this.ui.mono)&&(253&this.ui.mono||this.ui.flush(),this.ui.mono^=2),this.ui.buffer+=a)},print:function(a,b){if(0===a&&(b=""+b),1===a&&(b=String.fromCharCode(b)),
2===a&&(b=this.jit[b]||this.decode(b)),3===a)b=this.m.getUint16(this.objects+14*b+12),b=this.decode(b+1,2*this.m.getUint8(b));if(4===a){if(!this.unicode_table[b])return;b=this.unicode_table[b]}this._print(b)},print_table:function(a,b,c,d){c=c||1;d=d||0;for(var e=0;c>e++;)this._print(this.zscii_to_text(this.m.getBuffer(a,b))+(c>e?"\r":"")),a+=b+d},put_prop:function(a,b,c){var d=this.m;a=this.find_prop(a,b);(64&d.getUint8(a-1)?d.setUint16:d.setUint8)(a,c)},random:function(a){var b=this.xorshift_seed;
return 1>a?(this.xorshift_seed=a,0):0===b?0|1+Math.random()*a:(b^=65535&b<<4,b^=65535&b>>3,this.xorshift_seed=b^=65535&b<<7,1+b%a)},read:function(a,b,c,d,e){3===arguments.length&&(e=c,c=d=0);this.act("read",{buffer:a,parse:b,len:this.m.getUint8(a),initiallen:this.m.getUint8(a+1),time:c,routine:d,storer:e})},read_char:function(a,b,c,d){2===arguments.length&&(d=b,b=c=0);this.act("char",{time:b,routine:c,storer:d})},remove_obj:function(a){var b,c,d,e=this.get_parent(a);if(0!==e)if(b=this.get_child(e),
c=this.get_sibling(a),b===a)this.set_family(a,0,e,c);else{for(;d=this.get_sibling(b),d!==a;)b=d;this.set_family(a,0,0,0,b,c)}},restart:function(){var a=X(this.data),b=a.getUint8(0),c=5===b?4:8,d=a.getUint16(10),e=a.getUint16(54);if(5!==b&&8!==b)throw Error("Unsupported Z-Machine version: "+b);this.m&&a.setUint8(17,this.m.getUint8(17));x(this,{m:a,s:[],l:[],call_stack:[],undo:[],orders:[],streams:[1,0,[],0],version:b,pc:a.getUint16(6),properties:d,objects:d+112,globals:a.getUint16(12),staticmem:a.getUint16(14),
eof:(a.getUint16(26)||65536)*c,extension:e,extension_count:e?a.getUint16(e):0,addr_multipler:c});this.ui=new S(this,2&a.getUint8(17));this.init_text();this.update_header()},restore:function(a){var b=new R(a);var c=b.memory;a=b.stacks;var d=b.pc,e=this.m.getUint8(17),l=0,g=0,f=[],m=[];if(this.m.setBuffer(0,this.data.slice(0,this.staticmem)),b.compressed)for(;c.length>l;)b=c[l++],0===b?g+=1+c[l++]:this.m.setUint8(g,b^this.data[g++]);else this.m.setBuffer(0,c);this.m.setUint8(17,e);l=6;b=a[l++]<<8|a[l++];
for(c=D(a.slice(l,b));a.length>l;){f.unshift([a[l++]<<16|a[l++]<<8|a[l++],0,0,c.length,0,m.length]);f[0][1]=16&a[l]?-1:a[l+1];f[0][2]=15&a[l];l+=2;for(b=a[l++];b;)f[0][4]++,b>>=1;b=2*(a[l++]<<8|a[l++]);m=D(a.slice(l,l+=2*f[0][2])).concat(m);c=c.concat(D(a.slice(l,l+=b)))}this.call_stack=f;this.l=m;this.s=c;this.update_header();this.variable(this.m.getUint8(d++),2);this.pc=d},restore_undo:function(){if(0===this.undo.length)return 0;var a=this.undo.pop();return this.pc=a[0],a[2][17]=this.m.getUint8(17),
this.m.setBuffer(0,a[2]),this.l=a[3],this.s=a[4],this.call_stack=a[5],this.variable(a[1],2),1},ret:function(a){var b=this.call_stack.shift(),c=b[1];this.pc=b[0];this.l=this.l.slice(this.l.length-b[5]);this.s.length=b[3];0<=c&&this.variable(c,0|a)},save:function(a,b){var c=this.m;var d=this.s,e=this.l,f=new R;var g=[];var u=0;var m=this.call_stack.reverse(),h=[0,0,0,0,0,0];f.release=c.getBuffer(2,2);f.serial=c.getBuffer(18,6);f.checksum=c.getBuffer(28,2);f.pc=a;f.compressed=1;for(a=0;this.staticmem>
a;a++){var k=c.getUint8(a)^this.data[a];0===k?256===++u&&(g.push(0,255),u=0):(u&&(g.push(0,u-1),u=0),g.push(k))}f.memory=g;h.push(m[0][3]>>8,255&m[0][3]);for(c=0;m[0][3]>c;c++)h.push(d[c]>>8,255&d[c]);for(a=0;m.length>a;a++){g=m[a];u=(m[a+1]?m[a+1][3]:d.length)-g[3];h.push(g[0]>>16,255&g[0]>>8,255&g[0],g[2]|(0>g[1]?16:0),0>g[1]?0:g[1],(1<<g[4])-1,u>>8,255&u);for(c=e.length-g[5]-g[2];e.length-g[5]>c;c++)h.push(e[c]>>8,255&e[c]);for(c=g[3];g[3]+u>c;c++)h.push(d[c]>>8,255&d[c])}m.reverse();f.stacks=
h;this.act("save",{data:f.write(),storer:b})},save_undo:function(a,b){return this.undo.push([a,b,this.m.getBuffer(0,this.staticmem),this.l.slice(),this.s.slice(),this.call_stack.slice()]),1},scan_table:function(a,b,c,d){d=d||130;var e=128&d?this.m.getUint16:this.m.getUint8;d&=127;for(c=b+c*d;c>b;){if(e(b)===a)return b;b+=d}return 0},set_attr:function(a,b){a=0|this.objects+14*a+b/8;this.m.setUint8(a,this.m.getUint8(a)|128>>b%8)},set_family:function(a,b,c,d,e,f){this.m.setUint16(this.objects+14*a+6,
b);c&&this.m.setUint16(this.objects+14*c+10,d);e&&this.m.setUint16(this.objects+14*e+8,f)},test:function(a,b){return a&b===b},test_attr:function(a,b){return 128&this.m.getUint8(0|this.objects+14*a+b/8)<<b%8},update_header:function(){var a=this.m;this.xorshift_seed=0;a.setUint8(1,29|(this.env.timed?128:0));a.setUint8(17,87&a.getUint8(17));a.setUint8(32,255);a.setUint8(33,this.env.width);a.setUint16(34,this.env.width);a.setUint16(36,255);a.setUint16(38,257);a.setUint16(50,258);this.extension_table(4,
0);this.ui.update_header()},variable:function(a,b){var c=void 0!==b;if(0===a){if(!c)return this.s.pop();this.s.push(b)}else if(15>--a){if(!c)return this.l[a];this.l[a]=b}else{if(a=this.globals+2*(a-15),!c)return this.m.getUint16(a);this.m.setUint16(a,b)}return b},U2S:y,S2U:function(a){return 65535&a},init_text:function(){var a=this,b=this.m,c=b.getUint16(52),d=this.extension_table(3),e=d&&b.getUint8(d++);(function(b){for(var c=[[],[],[]],d=0;78>d;)c[0|d/26][d%26]=b[d++];c[2][1]=13;a.alphabets=c})(c?
b.getBuffer(c,78):this.text_to_zscii("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ \r0123456789.,!?_#'\"/\\-:()",1));(function(b){for(var c={13:"\r"},d={13:13},e=0;b.length>e;)c[155+e]=String.fromCharCode(b[e]),d[b[e]]=155+e++;for(e=32;127>e;)c[e]=String.fromCharCode(e),d[e]=e++;a.unicode_table=c;a.reverse_unicode_table=d})(d?b.getBuffer16(d,e):this.text_to_zscii(unescape("%E4%F6%FC%C4%D6%DC%DF%BB%AB%EB%EF%FF%CB%CF%E1%E9%ED%F3%FA%FD%C1%C9%CD%D3%DA%DD%E0%E8%EC%F2%F9%C0%C8%CC%D2%D9%E2%EA%EE%F4%FB%C2%CA%CE%D4%DB%E5%C5%F8%D8%E3%F1%F5%C3%D1%D5%E6%C6%E7%C7%FE%F0%DE%D0%A3%u0153%u0152%A1%BF"),
1));this.dictionaries={};this.dict=b.getUint16(8);this.parse_dict(this.dict)},decode:function(a,b){var c,d,e,f=this.m,g=a,h=[],m=0,k=0,p=[],n=[],q=0;if(this.jit[a])return this.jit[a];for(b=b?b+a:this.eof;b>a&&(c=f.getUint16(a),a+=2,h.push(31&c>>10,31&c>>5,31&c),!(32768&c)););for(;h.length>m;){if(d=h[m++],0===d)p.push(32);else if(4>d){var r=1;p.push(-1);n.push("\ue000+this.abbr("+(32*(d-1)+h[m++])+")+\ue000")}else if(6>d)k=d;else if(2===k&&6===d){if(h.length>m+1)if(e=h[m++]<<5|h[m++],768>e)p.push(e);
else{e-=767;q+=e;c=m;for(m=m%3+3;e--;)p.push(-1),n.push(String.fromCharCode(h[m]<<10|h[m+1]<<5|h[m+2])),h[m++]=h[m++]=h[m++]=32;m=c}}else 32>d&&p.push(this.alphabets[k][d-6]);k=4>k?0:k-3;0===m%3&&(m+=q,q=0)}return p=this.zscii_to_text(p,n),r&&(p={toString:U(Function('return"'+p.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\r/g,"\\r").replace(/\uE000/g,'"')+'"'),this)}),g>=this.staticmem&&(this.jit[g]=p),p},encode:function(a){for(var b,c,d=this.alphabets,e=[],f=0,g=[];9>e.length;)b=a[f++],32===
b?e.push(0):0<=(c=d[0].indexOf(b))?e.push(c+6):0<=(c=d[1].indexOf(b))?e.push(4,c+6):0<=(c=d[2].indexOf(b))?e.push(5,c+6):(c=this.reverse_unicode_table[b])?e.push(5,6,c>>5,31&c):void 0===b&&e.push(5);e.length=9;for(f=0;9>f;)g.push(e[f++]<<2|e[f]>>3,(7&e[f++])<<5|e[f++]);return g[4]|=128,g},zscii_to_text:function(a,b){for(var c,d=0,e=a.length,f=0,g="";e>d;)c=a[d++],-1===c&&(g+=b[f++]),(c=this.unicode_table[c])&&(g+=c);return g},text_to_zscii:function(a,b){for(var c,d=[],e=0,f=a.length;f>e;)c=a.charCodeAt(e++),
b||(c=this.reverse_unicode_table[c]||63),d.push(c);return d},parse_dict:function(a){var b=this.m,c=a,d={};var e=b.getUint8(a++);d.separators=b.getBuffer(a,e);a+=e;e=b.getUint8(a++);var f=a+2+e*b.getUint16(a);for(a+=2;f>a;)d[""+b.getBuffer(a,6)]=a,a+=e;return this.dictionaries[c]=d,d},abbr:function(a){var b=this.m;return this.decode(2*b.getUint16(b.getUint16(24)+2*a))},tokenise:function(a,b,c,d){c=c||this.dict;c=this.dictionaries[c]||this.parse_dict(c);for(var e,f=this.m,g=2,h=g+f.getUint8(a+1),m=
c.separators,k=[],p=[],n=g,q=0;h>g;)e=f.getUint8(a+g++),32===e||0<=m.indexOf(e)?(k.length&&(p.push([k,n]),n+=k.length,k=[]),32!==e&&p.push([[e],n]),n++):k.push(e);k.length&&p.push([k,n]);for(a=Math.min(p.length,f.getUint8(b));a>q;)k=c[""+this.encode(p[q][0])],d&&!k||(f.setUint16(b+2+4*q,k||0),f.setUint8(b+4+4*q,p[q][0].length),f.setUint8(b+5+4*q,p[q][1])),q++;f.setUint8(b+1,q)},keyinput:function(a){var b=a.charCode;a=a.keyCode;for(var c={8:8,13:13,27:27,37:131,38:129,39:132,40:130},d=96;106>d;)c[d]=
49+d++;for(d=112;124>d;)c[d]=21+d++;return c[a]?c[a]:this.reverse_unicode_table[b]||63},disassemble:function(){function a(a,b){for(var c=0;4>c;c++)b.push((192&a)>>6),a<<=2}for(var b,c,d,e,f,g,h,k=this.m,n=new Y(this,this.pc);;){if(c=b=this.pc,e=k.getUint8(b++),190===e?(g=-1,e=k.getUint8(b++)+1E3):128&e?64&e?(g=-1,32&e||(e&=31)):(g=[(48&e)>>4],3>g[0]&&(e&=207)):(g=[64&e?2:1,32&e?2:1],e&=31),!M[e])throw this.stop=1,Error("Unknown opcode #"+e+" at pc="+c);f=M[e].prototype;-1!==g||(g=[],a(k.getUint8(b++),
g),236!==e&&250!==e||a(k.getUint8(b++),g));h=[];for(d=0;g.length>d;)0===g[d]&&(h.push(new J(this,k.getUint16(b))),b+=2),1===g[d]&&h.push(new J(this,k.getUint8(b++))),2===g[d++]&&h.push(new w(this,k.getUint8(b++)));if(f.storer&&h.push(new w(this,k.getUint8(b++))),f.brancher&&(d=k.getUint8(b++),h.push([128&d,64&d?63&d:(d<<8|k.getUint8(b++))<<18>>18])),f.printer)for(h.push(b);this.eof>b&&(d=k.getUint8(b),b+=2,!(128&d)););if(this.pc=b,n.ops.push(new M[e](this,n,e,c,b,h)),d=0,0<=n.targets.indexOf(b)&&
(d=W(n,b)),f.stopper&&!d)break}return n},init:function(){this.jit={};this.env={width:80};V(this,["find_prop"])},inputEvent:function(a){var b,c=this.m,d=a.code;if(!a.env||(x(this.env,a.env),d)){if("load"===d)return this.data=a.data,void 0;this.orders=[];"restart"===d&&this.restart();"save"===d&&this.variable(a.storer,a.result||1);"restore"===d&&(this.m||this.restart(),a.data?this.restore(a.data):this.variable(a.storer,0));"read"===d&&(this.variable(a.storer,isNaN(a.terminator)?13:a.terminator),b=a.response,
this._print(b+"\r"),b=this.text_to_zscii(b.toLowerCase()),b.length>a.len&&(b=b.slice(0,a.len)),c.setUint8(a.buffer+1,b.length),c.setBuffer(a.buffer+2,b),a.parse&&this.tokenise(a.buffer,a.parse));"char"===d&&this.variable(a.storer,this.keyinput(a.response));"get_cursor"===d&&(c.setUint16(a.addr,a.pos[0]+1),c.setUint16(a.addr+2,a.pos[1]+1));this.run()}},run:function(){var a,b,c=new Date,d=0;for(this.stop=0;!this.stop;)if(a=this.pc,this.jit[a]||this.compile(),b=this.jit[a](this),isNaN(b)||this.ret(b),
0===++d%5E4&&5E3<new Date-c)return this.act("tick"),void 0},compile:function(){var a=this.disassemble();this.jit[a.pc]=Function("e",O(""+a));a.pc<this.staticmem&&I.warn("Caching a JIT function in dynamic memory: "+a.pc)},act:function(a,b){b=b||{};183===a&&(a="restart");186===a&&(a="quit");1001===a&&(a="restore",b={storer:b});this.ui.flush();this.ui.status.length&&(this.orders.push({code:"stream",to:"status",data:this.ui.status}),this.ui.status=[]);b.code=a;this.orders.push(b);this.stop=1;this.outputEvent&&
this.outputEvent(this.orders)}});return r.ZVMUI=S,"object"==typeof module&&"object"==typeof module.exports&&(module.exports=r),r}();
